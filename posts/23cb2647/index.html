<!DOCTYPE html>
<html lang="zh-CN" color-mode="light">

  <head>
  <meta name="msvalidate.01" content="7C83127B56F4119905E6D0B167D8128F" />
  <meta name="google-site-verification" content="ngKFKPTfonxvT8-y3gLrg9i03a0c7oKkL_EaN6gb0dc" />
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="author" content="No Name" />
  <!-- Open Graph Description ç®€çŸ­æ‘˜è¦-->
  
      <!-- ç”¨äºæœç´¢å¼•æ“çš„æ–‡ç« æ‘˜è¦ -->
      
          <meta name="description" content="ç•™æ¡£ä¸€äº›åˆ™è…¾ç¬”è®°" />
          
            
                
                  <title>
                    
                      åˆ©ç”¨Pythonæ‰¹é‡ä¸‹è½½RSSæºå›¾ç‰‡é›†
                        
                              
                                    |
                                    
                                      ï¼¸å°ç«™
                  </title>

                  
                    <link rel="apple-touch-icon" href="/images/favicon.svg">
                    <link rel="icon" href="/images/favicon.svg">
                    

                      <!-- Raleway-Font -->
                      <!-- 
  <link href="https://fonts.googleapis.com/css?family=Raleway:wght@400;700&display=swap" rel="stylesheet">
  -->


                      <!-- hexo site css -->
                      <link rel="stylesheet" href="/css/main.css" />
                      <link rel="stylesheet" href="//at.alicdn.com/t/font_1886449_67xjft27j1l.css" />
                      <!-- ä»£ç å—é£æ ¼ -->
                      
                        
<link rel="stylesheet" href="/css/figcaption/mac-block.css">

                          

                            <!-- jquery3.3.1 -->
                            
                                <script defer type="text/javascript" src="/plugins/jquery.min.js"></script>
                                

                                  <!-- fancybox -->
                                  
                                      <link href="/plugins/jquery.fancybox.min.css" rel="stylesheet">
                                      <script defer type="text/javascript"
                                        src="/plugins/jquery.fancybox.min.js"></script>
                                      
                                        
<script src="/js/fancybox.js"></script>


                                          

                                              

                                                  <script>
                                                    var html = document.documentElement
                                                    const colorMode = localStorage.getItem('color-mode')
                                                    if (colorMode) {
                                                      document.documentElement.setAttribute('color-mode', colorMode)
                                                    }
                                                  </script>

                                                  
                                                    
<meta name="generator" content="Hexo 7.3.0"></head>

  <body>
    <div id="app">
      <div class="header">
  <div class="avatar">
    <a href="/">
      <!-- å¤´åƒå–æ¶ˆæ‡’åŠ è½½ï¼Œæ·»åŠ no-lazy -->
      
        <img no-lazy src="/images/logo.svg" alt="">
      
    </a>
    <div class="nickname"><a href="/"></a></div>
  </div>
  <div class="navbar">
    <ul>
      
        <li class="nav-item" data-path="/">
          <a href="/">ä¸»é¡µ</a>
        </li>
      
        <li class="nav-item" data-path="/archives/">
          <a href="/archives/">å½’æ¡£</a>
        </li>
      
        <li class="nav-item" data-path="/tags/">
          <a href="/tags/">æ ‡ç­¾</a>
        </li>
      
        <li class="nav-item" data-path="/notes/">
          <a href="/notes/">ç¬”è®°</a>
        </li>
      
    </ul>
  </div>
</div>


<script src="/js/activeNav.js"></script>



      <div class="flex-container">
        <!-- æ–‡ç« è¯¦æƒ…é¡µï¼Œå±•ç¤ºæ–‡ç« å…·ä½“å†…å®¹ï¼Œurlå½¢å¼ï¼šhttps://yoursite/æ–‡ç« æ ‡é¢˜/ -->
<!-- åŒæ—¶ä¸ºã€Œæ ‡ç­¾tagã€ï¼Œã€Œæœ‹å‹friendã€ï¼Œã€Œåˆ†ç±»categoriesã€ï¼Œã€Œå…³äºaboutã€é¡µé¢çš„æ‰¿è½½é¡µé¢ï¼Œå…·ä½“å±•ç¤ºå–å†³äºpage.type -->


  <!-- LaTex Display -->

  
    <script async type="text/javascript" src="/plugins/mathjax/tex-chtml.js"></script>
  
  <script>
    MathJax = {
      tex: {
        inlineMath: [['$', '$'], ['\\(', '\\)']]
      }
    }
  </script>





  <!-- clipboard -->

  
    <script async type="text/javascript" src="/plugins/clipboard.min.js"></script>
  
  
<script src="/js/codeCopy.js"></script>







  

  

  

  
  <!-- æ–‡ç« å†…å®¹é¡µ urlå½¢å¼ï¼šhttps://yoursite/æ–‡ç« æ ‡é¢˜/ -->
  <div class="container post-details" id="post-details">
    <div class="post-content">
      <div class="post-title">åˆ©ç”¨Pythonæ‰¹é‡ä¸‹è½½RSSæºå›¾ç‰‡é›†</div>
      <div class="post-attach">
        <span class="post-pubtime">
          <i class="iconfont icon-updatetime mr-10" title="æ›´æ–°æ—¶é—´"></i>
          2025-06-28 04:23:53
        </span>
        
              <span class="post-tags">
                <i class="iconfont icon-tags mr-10" title="æ ‡ç­¾"></i>
                
                <span class="span--tag mr-8">
                  <a href="/tags/Python/" title="Python">
                    #Python
                  </a>
                </span>
                
              </span>
          
      </div>
      <div class="markdown-body">
        <h2 id="âš ï¸-æ³¨æ„äº‹é¡¹"><a href="#âš ï¸-æ³¨æ„äº‹é¡¹" class="headerlink" title="âš ï¸ æ³¨æ„äº‹é¡¹"></a>âš ï¸ æ³¨æ„äº‹é¡¹</h2><ul>
<li>è¯·å°Šé‡ç½‘ç«™çš„ç‰ˆæƒå’Œ robots.txt åè®®ã€‚</li>
<li>è¯·å‹¿å°†å¹¶å‘æ•°è®¾ç½®å¾—è¿‡é«˜ï¼Œè¿‡åº¦é¢‘ç¹çš„è¯·æ±‚å¯èƒ½ä¼šç»™ç›®æ ‡æœåŠ¡å™¨å¸¦æ¥è¾ƒå¤§è´Ÿæ‹…ï¼Œç”šè‡³å¯¼è‡´ä½ IPè¢«å°ç¦ã€‚</li>
<li>æœ¬è„šæœ¬ä»…ä¾›å­¦ä¹ å’Œä¸ªäººæ”¶è—ç”¨é€”ï¼Œè¯·å‹¿ç”¨äºéæ³•å•†ä¸šæ´»åŠ¨ã€‚</li>
</ul>
<h2 id="ğŸ“-æ–‡ä»¶ç»“æ„"><a href="#ğŸ“-æ–‡ä»¶ç»“æ„" class="headerlink" title="ğŸ“ æ–‡ä»¶ç»“æ„"></a>ğŸ“ æ–‡ä»¶ç»“æ„</h2><p>åœ¨è¿è¡Œå‰ï¼Œè¯·ç¡®ä¿æ‚¨çš„é¡¹ç›®æ–‡ä»¶å¤¹åŒ…å«ä»¥ä¸‹æ–‡ä»¶ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">.</span><br><span class="line">â”œâ”€â”€ downloader.py  # ä¸»ç¨‹åºè„šæœ¬</span><br><span class="line">â”œâ”€â”€ config.yaml            # é…ç½®æ–‡ä»¶</span><br><span class="line">â”œâ”€â”€ requirements.txt       # Python ä¾èµ–åº“</span><br><span class="line">â”œâ”€â”€ feeds.opml             # ä½ çš„ RSS è®¢é˜…åˆ—è¡¨ (éœ€è‡ªè¡Œå‡†å¤‡)</span><br><span class="line">â”‚</span><br><span class="line">â”œâ”€â”€ history.db             # (ç¨‹åºé¦–æ¬¡è¿è¡Œåè‡ªåŠ¨ç”Ÿæˆ) ä¸‹è½½å†å²æ•°æ®åº“</span><br><span class="line">â””â”€â”€ downloader_errors.log  # (å‡ºç°é”™è¯¯åè‡ªåŠ¨ç”Ÿæˆ) é”™è¯¯æ—¥å¿—æ–‡ä»¶</span><br></pre></td></tr></table></figure>

<p><em>(å¯é€‰æ–‡ä»¶)</em></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">â””â”€â”€ cookies.txt            # (å¯é€‰) ç”¨äºæ¨¡æ‹Ÿç™»å½•çš„Cookieæ–‡ä»¶</span><br></pre></td></tr></table></figure>

<h2 id="ğŸ-ä¸»ç¨‹åº"><a href="#ğŸ-ä¸»ç¨‹åº" class="headerlink" title="ğŸ ä¸»ç¨‹åº"></a>ğŸ ä¸»ç¨‹åº</h2><p><code>downloader.py</code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br></pre></td><td class="code"><pre><span class="line">import asyncio</span><br><span class="line">import os</span><br><span class="line">import re</span><br><span class="line">import time</span><br><span class="line">import feedparser</span><br><span class="line">import aiohttp</span><br><span class="line">import aiosqlite</span><br><span class="line">import yaml</span><br><span class="line">import html</span><br><span class="line">import argparse</span><br><span class="line">import logging</span><br><span class="line">import random</span><br><span class="line">from bs4 import BeautifulSoup</span><br><span class="line">from urllib.parse import urlparse, urljoin</span><br><span class="line">from tqdm.asyncio import tqdm as aio_tqdm</span><br><span class="line">from http.cookies import SimpleCookie</span><br><span class="line"></span><br><span class="line"># ==============================================================================</span><br><span class="line"># æ—¥å¿—è®¾ç½®</span><br><span class="line"># ==============================================================================</span><br><span class="line">logger = logging.getLogger(&quot;ä¸‹è½½å™¨&quot;)</span><br><span class="line"></span><br><span class="line">def setup_loggers(console_level=logging.INFO, error_file=&#x27;downloader_errors.log&#x27;):</span><br><span class="line">    &quot;&quot;&quot;é…ç½®æ§åˆ¶å°å’Œæ–‡ä»¶æ—¥å¿—è®°å½•å™¨ã€‚&quot;&quot;&quot;</span><br><span class="line">    if logger.hasHandlers():</span><br><span class="line">        logger.handlers.clear()</span><br><span class="line">        </span><br><span class="line">    logger.setLevel(logging.DEBUG)</span><br><span class="line"></span><br><span class="line">    # 1. æ§åˆ¶å°å¤„ç†å™¨</span><br><span class="line">    console_handler = logging.StreamHandler()</span><br><span class="line">    console_handler.setLevel(console_level)</span><br><span class="line">    console_formatter = logging.Formatter(</span><br><span class="line">        &#x27;%(asctime)s - %(levelname)s - [%(name)s] - %(message)s&#x27;,</span><br><span class="line">        datefmt=&#x27;%Y-%m-%d %H:%M:%S&#x27;</span><br><span class="line">    )</span><br><span class="line">    console_handler.setFormatter(console_formatter)</span><br><span class="line">    logger.addHandler(console_handler)</span><br><span class="line"></span><br><span class="line">    # 2. é”™è¯¯æ–‡ä»¶å¤„ç†å™¨</span><br><span class="line">    try:</span><br><span class="line">        file_handler = logging.FileHandler(error_file, &#x27;a&#x27;, encoding=&#x27;utf-8&#x27;)</span><br><span class="line">        file_handler.setLevel(logging.WARNING)</span><br><span class="line">        file_formatter = logging.Formatter(</span><br><span class="line">            &#x27;%(asctime)s - %(levelname)s - %(message)s&#x27;</span><br><span class="line">        )</span><br><span class="line">        file_handler.setFormatter(file_formatter)</span><br><span class="line">        logger.addHandler(file_handler)</span><br><span class="line">        logger.info(f&quot;é”™è¯¯æ—¥å¿—å°†è®°å½•åˆ°: &#123;os.path.abspath(error_file)&#125;&quot;)</span><br><span class="line">    except Exception as e:</span><br><span class="line">        logger.error(f&quot;æ— æ³•åˆ›å»ºé”™è¯¯æ—¥å¿—æ–‡ä»¶ &#123;error_file&#125;: &#123;e&#125;&quot;)</span><br><span class="line"></span><br><span class="line"># ==============================================================================</span><br><span class="line"># é…ç½®åŠ è½½ä¸æ­£åˆ™è¡¨è¾¾å¼é¢„ç¼–è¯‘</span><br><span class="line"># ==============================================================================</span><br><span class="line">CONFIG = &#123;&#125;</span><br><span class="line">REGEX = &#123;</span><br><span class="line">    &quot;image_file_ext&quot;: re.compile(r&#x27;\.(jpg|jpeg|png|webp|gif)$&#x27;, re.I),</span><br><span class="line">    &quot;blogspot_thumb&quot;: re.compile(r&#x27;/s\d+(-[a-z])?/&#x27;, re.I),</span><br><span class="line">    &quot;thumbnail_resize&quot;: re.compile(r&#x27;-\d+x\d+(\.\w+)$&#x27;),</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">def load_config(path=&#x27;config.yaml&#x27;):</span><br><span class="line">    &quot;&quot;&quot;ä» YAML æ–‡ä»¶åŠ è½½é…ç½®ã€‚&quot;&quot;&quot;</span><br><span class="line">    global CONFIG</span><br><span class="line">    try:</span><br><span class="line">        with open(path, &#x27;r&#x27;, encoding=&#x27;utf-8&#x27;) as f:</span><br><span class="line">            CONFIG = yaml.safe_load(f)</span><br><span class="line">        setup_loggers(error_file=CONFIG.get(&#x27;error_log_file&#x27;, &#x27;downloader_errors.log&#x27;))</span><br><span class="line">        logger.info(&quot;æˆåŠŸä» %s åŠ è½½é…ç½®ã€‚&quot;, path)</span><br><span class="line">    except FileNotFoundError:</span><br><span class="line">        print(f&quot;è‡´å‘½é”™è¯¯: æœªæ‰¾åˆ° &#123;path&#125; æ–‡ä»¶ï¼Œè¯·åˆ›å»ºå®ƒã€‚&quot;)</span><br><span class="line">        exit(1)</span><br><span class="line">    except Exception as e:</span><br><span class="line">        print(f&quot;è‡´å‘½é”™è¯¯: åŠ è½½ &#123;path&#125; å‡ºé”™: &#123;e&#125;&quot;)</span><br><span class="line">        exit(1)</span><br><span class="line"></span><br><span class="line"># ==============================================================================</span><br><span class="line"># æ•°æ®åº“ä¸Cookie (å¼‚æ­¥)</span><br><span class="line"># ==============================================================================</span><br><span class="line">class DatabaseManager:</span><br><span class="line">    &quot;&quot;&quot;å¼‚æ­¥ç®¡ç†ç”¨äºå­˜å‚¨ä¸‹è½½å†å²çš„ SQLite æ•°æ®åº“ (åŸºäºæ–‡ç« æ ‡é¢˜å…¨å±€å»é‡)ã€‚&quot;&quot;&quot;</span><br><span class="line">    def __init__(self, db_path):</span><br><span class="line">        self._db_path = db_path</span><br><span class="line">        self._conn = None</span><br><span class="line"></span><br><span class="line">    async def connect(self):</span><br><span class="line">        try:</span><br><span class="line">            self._conn = await aiosqlite.connect(self._db_path)</span><br><span class="line">            await self._conn.execute(&quot;PRAGMA journal_mode=WAL;&quot;)</span><br><span class="line">            await self._conn.execute(&quot;&quot;&quot;</span><br><span class="line">                CREATE TABLE IF NOT EXISTS download_history (</span><br><span class="line">                    post_title TEXT PRIMARY KEY,</span><br><span class="line">                    download_date TEXT NOT NULL,</span><br><span class="line">                    source_feed TEXT</span><br><span class="line">                )</span><br><span class="line">            &quot;&quot;&quot;)</span><br><span class="line">            await self._conn.commit()</span><br><span class="line">            logger.info(&quot;æ•°æ®åº“è¿æ¥æˆåŠŸ (å…¨å±€å»é‡æ¨¡å¼): %s&quot;, self._db_path)</span><br><span class="line">        except Exception as e:</span><br><span class="line">            logger.error(&quot;æ•°æ®åº“è¿æ¥å¤±è´¥: %s&quot;, e)</span><br><span class="line">            raise</span><br><span class="line"></span><br><span class="line">    async def is_downloaded(self, post_title):</span><br><span class="line">        &quot;&quot;&quot;æ£€æŸ¥ä¸€ä¸ªæ–‡ç« æ ‡é¢˜æ˜¯å¦å·²ç»è¢«ä¸‹è½½è¿‡ã€‚&quot;&quot;&quot;</span><br><span class="line">        async with self._conn.execute(</span><br><span class="line">            &quot;SELECT 1 FROM download_history WHERE post_title = ?&quot;,</span><br><span class="line">            (post_title,)</span><br><span class="line">        ) as cursor:</span><br><span class="line">            return await cursor.fetchone() is not None</span><br><span class="line"></span><br><span class="line">    async def add_entry(self, post_title, feed_title):</span><br><span class="line">        &quot;&quot;&quot;å°†ä¸€ä¸ªæ–‡ç« æ ‡é¢˜æ·»åŠ åˆ°ä¸‹è½½å†å²ä¸­ã€‚&quot;&quot;&quot;</span><br><span class="line">        now = time.strftime(&#x27;%Y-%m-%d %H:%M:%S&#x27;)</span><br><span class="line">        try:</span><br><span class="line">            await self._conn.execute(</span><br><span class="line">                &quot;INSERT OR IGNORE INTO download_history (post_title, download_date, source_feed) VALUES (?, ?, ?)&quot;,</span><br><span class="line">                (post_title, now, feed_title)</span><br><span class="line">            )</span><br><span class="line">            await self._conn.commit()</span><br><span class="line">        except Exception as e:</span><br><span class="line">            logger.error(&quot;æ·»åŠ è®°å½• &#x27;%s&#x27; åˆ°æ•°æ®åº“å¤±è´¥: %s&quot;, post_title, e)</span><br><span class="line"></span><br><span class="line">    async def close(self):</span><br><span class="line">        if self._conn:</span><br><span class="line">            await self._conn.close()</span><br><span class="line">            logger.info(&quot;æ•°æ®åº“è¿æ¥å·²å…³é—­ã€‚&quot;)</span><br><span class="line"></span><br><span class="line">class NetscapeCookieJar(aiohttp.CookieJar):</span><br><span class="line">    &quot;&quot;&quot;ä¸€ä¸ªå¯ä»¥ä» Netscape æ ¼å¼çš„ cookies.txt æ–‡ä»¶åŠ è½½ cookie çš„ CookieJarã€‚&quot;&quot;&quot;</span><br><span class="line">    def __init__(self, cookie_file=None):</span><br><span class="line">        super().__init__()</span><br><span class="line">        if cookie_file and os.path.exists(cookie_file):</span><br><span class="line">            self.load_from_file(cookie_file)</span><br><span class="line"></span><br><span class="line">    def load_from_file(self, cookie_file):</span><br><span class="line">        try:</span><br><span class="line">            with open(cookie_file, &#x27;r&#x27;) as f:</span><br><span class="line">                for line in f:</span><br><span class="line">                    if line.strip().startswith(&#x27;#&#x27;) or not line.strip():</span><br><span class="line">                        continue</span><br><span class="line">                    </span><br><span class="line">                    try:</span><br><span class="line">                        domain, _, path, secure, expires, name, value = line.strip().split(&#x27;\t&#x27;)</span><br><span class="line">                        cookie = SimpleCookie()</span><br><span class="line">                        cookie[name] = value</span><br><span class="line">                        cookie[name][&#x27;path&#x27;] = path</span><br><span class="line">                        cookie[name][&#x27;domain&#x27;] = domain</span><br><span class="line">                        cookie[name][&#x27;expires&#x27;] = int(float(expires))</span><br><span class="line">                        cookie[name][&#x27;secure&#x27;] = secure.upper() == &#x27;TRUE&#x27;</span><br><span class="line">                        self.update_cookies(cookie)</span><br><span class="line">                    except ValueError:</span><br><span class="line">                        logger.warning(f&quot;æ— æ³•è§£æCookieè¡Œ: &#123;line.strip()&#125;&quot;)</span><br><span class="line">                logger.info(f&quot;æˆåŠŸä» &#123;cookie_file&#125; åŠ è½½ Cookiesã€‚&quot;)</span><br><span class="line">        except Exception as e:</span><br><span class="line">            logger.error(f&quot;åŠ è½½Cookiesæ–‡ä»¶ &#123;cookie_file&#125; å¤±è´¥: &#123;e&#125;&quot;)</span><br><span class="line"></span><br><span class="line"># ==============================================================================</span><br><span class="line"># å·¥å…·å‡½æ•°</span><br><span class="line"># ==============================================================================</span><br><span class="line">def sanitize_folder_name(name):</span><br><span class="line">    sanitized = html.unescape(name).strip()</span><br><span class="line">    invalid_chars = r&#x27;[\\/:*?&quot;&lt;&gt;|]&#x27;</span><br><span class="line">    sanitized = re.sub(invalid_chars, &#x27;_&#x27;, sanitized)</span><br><span class="line">    return sanitized or &quot;æœªå‘½å&quot;</span><br><span class="line"></span><br><span class="line">def get_full_image_url(url):</span><br><span class="line">    if &quot;bp.blogspot.com&quot; in url or &quot;googleusercontent.com&quot; in url:</span><br><span class="line">        return REGEX[&quot;blogspot_thumb&quot;].sub(&#x27;/s0/&#x27;, url)</span><br><span class="line">    if REGEX[&quot;thumbnail_resize&quot;].search(url):</span><br><span class="line">        return REGEX[&quot;thumbnail_resize&quot;].sub(r&#x27;\1&#x27;, url)</span><br><span class="line">    return url</span><br><span class="line"></span><br><span class="line"># ==============================================================================</span><br><span class="line"># ç½‘ç»œä¸ä¸‹è½½æ ¸å¿ƒ (å¼‚æ­¥)</span><br><span class="line"># ==============================================================================</span><br><span class="line">async def fetch(session, url, log_prefix=&quot;&quot;):</span><br><span class="line">    for attempt in range(CONFIG.get(&#x27;max_retries&#x27;, 3) + 1):</span><br><span class="line">        try:</span><br><span class="line">            async with session.get(url, timeout=CONFIG.get(&#x27;request_timeout&#x27;, 45), headers=CONFIG.get(&#x27;request_headers&#x27;, &#123;&#125;)) as response:</span><br><span class="line">                response.raise_for_status()</span><br><span class="line">                return await response.text()</span><br><span class="line">        except (aiohttp.ClientError, asyncio.TimeoutError) as e:</span><br><span class="line">            if attempt &lt; CONFIG.get(&#x27;max_retries&#x27;, 3):</span><br><span class="line">                delay = CONFIG.get(&#x27;retry_delay&#x27;, 2) * (2 ** attempt)</span><br><span class="line">                logger.warning(&quot;%sç¬¬ %d/%d æ¬¡æŠ“å– %s å¤±è´¥ã€‚å°†åœ¨ %.1f ç§’åé‡è¯•...&quot;, log_prefix, attempt + 1, CONFIG.get(&#x27;max_retries&#x27;, 3) + 1, url, delay)</span><br><span class="line">                await asyncio.sleep(delay)</span><br><span class="line">            else:</span><br><span class="line">                logger.error(&quot;%sæŠ“å– %s åœ¨ %d æ¬¡é‡è¯•åä»ç„¶å¤±è´¥: %s&quot;, log_prefix, url, CONFIG.get(&#x27;max_retries&#x27;, 3) + 1, e)</span><br><span class="line">                return None</span><br><span class="line"></span><br><span class="line">async def download_image(session, img_url, filepath, referer_url, log_prefix=&quot;&quot;):</span><br><span class="line">    &quot;&quot;&quot;å¼‚æ­¥ä¸‹è½½å•å¼ å›¾ç‰‡ï¼Œå¹¶åœ¨å¤±è´¥æ—¶è®°å½•è¯¦ç»†é”™è¯¯ã€‚&quot;&quot;&quot;</span><br><span class="line">    full_img_url = get_full_image_url(img_url)</span><br><span class="line">    headers = CONFIG.get(&#x27;image_headers&#x27;, &#123;&#125;).copy()</span><br><span class="line">    headers[&#x27;Referer&#x27;] = referer_url</span><br><span class="line">    last_exception = None</span><br><span class="line"></span><br><span class="line">    for attempt in range(CONFIG.get(&#x27;max_retries&#x27;, 3) + 1):</span><br><span class="line">        try:</span><br><span class="line">            async with session.get(full_img_url, timeout=CONFIG.get(&#x27;request_timeout&#x27;, 45), headers=headers) as response:</span><br><span class="line">                if response.status == 404 and full_img_url != img_url:</span><br><span class="line">                    logger.warning(&quot;%sé«˜æ¸…å›¾URL %s è¿”å›404ï¼Œå°è¯•åŸå§‹URL: %s&quot;, log_prefix, full_img_url, img_url)</span><br><span class="line">                    return await download_image(session, img_url, filepath, referer_url, log_prefix)</span><br><span class="line">                </span><br><span class="line">                response.raise_for_status()</span><br><span class="line">                </span><br><span class="line">                content = await response.read()</span><br><span class="line">                os.makedirs(os.path.dirname(filepath), exist_ok=True)</span><br><span class="line">                with open(filepath, &#x27;wb&#x27;) as f:</span><br><span class="line">                    f.write(content)</span><br><span class="line">                return True, os.path.basename(filepath)</span><br><span class="line"></span><br><span class="line">        except (aiohttp.ClientError, asyncio.TimeoutError) as e:</span><br><span class="line">            last_exception = e</span><br><span class="line">            if attempt &lt; CONFIG.get(&#x27;max_retries&#x27;, 3):</span><br><span class="line">                delay = CONFIG.get(&#x27;retry_delay&#x27;, 5) * (2 ** attempt)</span><br><span class="line">                await asyncio.sleep(delay)</span><br><span class="line">            else:</span><br><span class="line">                # æœ€ç»ˆå¤±è´¥æ—¶è®°å½•è¯¦ç»†é”™è¯¯</span><br><span class="line">                error_message = f&quot;é‡è¯• &#123;CONFIG.get(&#x27;max_retries&#x27;, 3) + 1&#125; æ¬¡åå¤±è´¥ã€‚URL: &#123;img_url&#125;&quot;</span><br><span class="line">                logger.error(&quot;%s%s, åº•å±‚é”™è¯¯: %s&quot;, log_prefix, error_message, last_exception, exc_info=False)</span><br><span class="line">                return False, str(last_exception)</span><br><span class="line">    return False, &quot;å·²è¾¾æœ€å¤§é‡è¯•æ¬¡æ•°&quot;</span><br><span class="line"></span><br><span class="line">async def fetch_paginated_content(session, url, log_prefix=&quot;&quot;):</span><br><span class="line">    &quot;&quot;&quot;å¼‚æ­¥è·å–ä¸€ä¸ªåˆ†é¡µæ–‡ç« çš„æ‰€æœ‰é¡µé¢HTMLå†…å®¹ã€‚&quot;&quot;&quot;</span><br><span class="line">    full_html = &quot;&quot;</span><br><span class="line">    current_url = url</span><br><span class="line">    processed_urls = set()</span><br><span class="line">    while current_url and current_url not in processed_urls:</span><br><span class="line">        logger.debug(&quot;%sæ­£åœ¨æŠ“å–åˆ†é¡µå†…å®¹: %s&quot;, log_prefix, current_url)</span><br><span class="line">        processed_urls.add(current_url)</span><br><span class="line">        html_content = await fetch(session, current_url, log_prefix)</span><br><span class="line">        if not html_content:</span><br><span class="line">            break</span><br><span class="line">        soup = BeautifulSoup(html_content, &#x27;html.parser&#x27;)</span><br><span class="line">        content_area = soup.select_one(&#x27;div.entry-content, div.post-content, article.post, div#content&#x27;)</span><br><span class="line">        if content_area:</span><br><span class="line">            full_html += str(content_area)</span><br><span class="line">        else:</span><br><span class="line">            full_html += html_content</span><br><span class="line">        next_page_link = soup.select_one(&#x27;a.next.page-numbers, a[rel=next], .pagination-next a, a:-soup-contains(&quot;Next Page&quot;)&#x27;)</span><br><span class="line">        if next_page_link and next_page_link.get(&#x27;href&#x27;):</span><br><span class="line">            current_url = urljoin(current_url, next_page_link[&#x27;href&#x27;])</span><br><span class="line">            await asyncio.sleep(random.uniform(0.5, 2.0)) # æŠ“å–åˆ†é¡µæ—¶ä¹Ÿå¢åŠ éšæœºå»¶è¿Ÿ</span><br><span class="line">        else:</span><br><span class="line">            current_url = None</span><br><span class="line">    return full_html</span><br><span class="line">    </span><br><span class="line">async def extract_images_from_page(session, article_url, log_prefix=&quot;&quot;):</span><br><span class="line">    &quot;&quot;&quot;(æ›´ç²¾ç¡®ç‰ˆ) ä»ä¸€ä¸ªå¯èƒ½åˆ†é¡µçš„æ–‡ç« ä¸­æå–æ‰€æœ‰å›¾ç‰‡URLã€‚&quot;&quot;&quot;</span><br><span class="line">    full_html_content = await fetch_paginated_content(session, article_url, log_prefix)</span><br><span class="line">    if not full_html_content:</span><br><span class="line">        return []</span><br><span class="line">        </span><br><span class="line">    soup = BeautifulSoup(full_html_content, &#x27;html.parser&#x27;)</span><br><span class="line">    image_urls = set()</span><br><span class="line">    content_area = soup.select_one(&#x27;div.entry-content, div.post-content, article.post, div#content&#x27;)</span><br><span class="line">    search_area = content_area if content_area else soup</span><br><span class="line"></span><br><span class="line">    for img in search_area.find_all(&#x27;img&#x27;):</span><br><span class="line">        src = img.get(&#x27;data-src&#x27;) or img.get(&#x27;src&#x27;)</span><br><span class="line">        if src:</span><br><span class="line">            full_url = urljoin(article_url, src.strip())</span><br><span class="line">            if REGEX[&quot;image_file_ext&quot;].search(full_url.split(&#x27;?&#x27;)[0]):</span><br><span class="line">                image_urls.add(full_url)</span><br><span class="line">    </span><br><span class="line">    return list(image_urls)</span><br><span class="line"></span><br><span class="line"># ==============================================================================</span><br><span class="line"># ä¸»è¦å¤„ç†é€»è¾‘ (å¼‚æ­¥)</span><br><span class="line"># ==============================================================================</span><br><span class="line">async def process_entry(session, db, entry, feed_title):</span><br><span class="line">    &quot;&quot;&quot;å¤„ç†å•ä¸ª RSS æ¡ç›®ï¼Œå¹¶è®°å½•ä¸‹è½½å¤±è´¥ (åŸºäºæ–‡ç« æ ‡é¢˜å…¨å±€å»é‡)ã€‚&quot;&quot;&quot;</span><br><span class="line">    entry_id = getattr(entry, &#x27;id&#x27;, entry.link)</span><br><span class="line">    article_url = entry.link</span><br><span class="line">    log_prefix = f&quot;[&#123;feed_title[:15]&#125;] &quot;</span><br><span class="line"></span><br><span class="line">    # 1. é¦–å…ˆè·å–å¹¶æ¸…ç†æ ‡é¢˜</span><br><span class="line">    post_title = sanitize_folder_name(entry.title)</span><br><span class="line"></span><br><span class="line">    # 2. ä½¿ç”¨æ¸…ç†åçš„æ ‡é¢˜è¿›è¡Œå…¨å±€é‡å¤æ£€æŸ¥</span><br><span class="line">    if not article_url or await db.is_downloaded(post_title):</span><br><span class="line">        if not article_url:</span><br><span class="line">            return 0, 0</span><br><span class="line">        logger.info(&quot;%sæ–‡ç«  &#x27;%s&#x27; å·²åœ¨å…¨å±€å†å²ä¸­å­˜åœ¨ï¼Œè·³è¿‡ã€‚&quot;, log_prefix, post_title)</span><br><span class="line">        return 0, 0</span><br><span class="line">    </span><br><span class="line">    # å¦‚æœæ²¡è·³è¿‡ï¼Œè¯´æ˜æ˜¯æ–°æ–‡ç« ï¼Œç»§ç»­å¤„ç†</span><br><span class="line">    logger.info(&quot;%så¤„ç†æ–°æ–‡ç« : &#x27;%s&#x27;&quot;, log_prefix, post_title)</span><br><span class="line"></span><br><span class="line">    image_urls = []</span><br><span class="line">    html_description = getattr(entry, &#x27;description&#x27;, &#x27;&#x27;)</span><br><span class="line"></span><br><span class="line">    if html_description:</span><br><span class="line">        soup = BeautifulSoup(html_description, &#x27;html.parser&#x27;)</span><br><span class="line">        gallery_div = soup.select_one(&#x27;div.gallery, div#gallery&#x27;)</span><br><span class="line">        if gallery_div:</span><br><span class="line">            links = gallery_div.select(&#x27;a&#x27;)</span><br><span class="line">            for link in links:</span><br><span class="line">                href = link.get(&#x27;href&#x27;)</span><br><span class="line">                if href and REGEX[&quot;image_file_ext&quot;].search(href.split(&#x27;?&#x27;)[0]):</span><br><span class="line">                    image_urls.append(urljoin(article_url, href.strip()))</span><br><span class="line">        </span><br><span class="line">        if not image_urls:</span><br><span class="line">            for img in soup.find_all(&#x27;img&#x27;):</span><br><span class="line">                src = img.get(&#x27;src&#x27;) or img.get(&#x27;data-src&#x27;)</span><br><span class="line">                if src:</span><br><span class="line">                    image_urls.append(urljoin(article_url, src.strip()))</span><br><span class="line"></span><br><span class="line">    if not image_urls and CONFIG.get(&#x27;allow_fallback_to_source_site&#x27;, False):</span><br><span class="line">        logger.warning(&quot;%såœ¨RSSæºä¸­æœªæ‰¾åˆ°å›¾ç‰‡ï¼Œå°†è®¿é—®æºç½‘ç«™: %s&quot;, log_prefix, article_url)</span><br><span class="line">        image_urls = await extract_images_from_page(session, article_url, log_prefix)</span><br><span class="line">    elif image_urls:</span><br><span class="line">        unique_urls = list(dict.fromkeys(image_urls))</span><br><span class="line">        image_urls = unique_urls</span><br><span class="line">        logger.info(&quot;%så·²æˆåŠŸä»RSSæºæè¿°ä¸­æå– %d ä¸ªå›¾ç‰‡åœ°å€ã€‚&quot;, log_prefix, len(image_urls))</span><br><span class="line"></span><br><span class="line">    if not image_urls:</span><br><span class="line">        logger.warning(&quot;%sæ–‡ç«  &#x27;%s&#x27; æœªèƒ½æ‰¾åˆ°ä»»ä½•å›¾ç‰‡ã€‚&quot;, log_prefix, post_title)</span><br><span class="line">        # å°†æ ‡é¢˜æ·»åŠ åˆ°æ•°æ®åº“</span><br><span class="line">        await db.add_entry(post_title, feed_title)</span><br><span class="line">        return 1, 0</span><br><span class="line"></span><br><span class="line">    post_folder = os.path.join(CONFIG[&#x27;base_folder&#x27;], sanitize_folder_name(feed_title), post_title)</span><br><span class="line">    extended_log_prefix = f&quot;[&#123;feed_title&#125;][&#123;post_title&#125;] &quot;</span><br><span class="line"></span><br><span class="line">    tasks = []</span><br><span class="line">    for i, img_url in enumerate(image_urls):</span><br><span class="line">        ext = os.path.splitext(urlparse(img_url).path)[1]</span><br><span class="line">        if not REGEX[&quot;image_file_ext&quot;].search(ext):</span><br><span class="line">            ext = &quot;.jpg&quot;</span><br><span class="line">        filename = f&quot;&#123;i+1:03d&#125;&#123;ext&#125;&quot;</span><br><span class="line">        filepath = os.path.join(post_folder, filename)</span><br><span class="line"></span><br><span class="line">        if not os.path.exists(filepath):</span><br><span class="line">            task = asyncio.create_task(download_image(session, img_url, filepath, article_url, extended_log_prefix))</span><br><span class="line">            tasks.append(task)</span><br><span class="line">        else:</span><br><span class="line">            await asyncio.sleep(0.05)</span><br><span class="line"></span><br><span class="line">    if not tasks:</span><br><span class="line">        logger.info(&quot;%sæ‰€æœ‰ %d å¼ å›¾ç‰‡å‡å·²å­˜åœ¨ï¼Œè·³è¿‡ä¸‹è½½ã€‚&quot;, extended_log_prefix, len(image_urls))</span><br><span class="line">        # å°†æ ‡é¢˜æ·»åŠ åˆ°æ•°æ®åº“</span><br><span class="line">        await db.add_entry(post_title, feed_title)</span><br><span class="line">        return 1, 0</span><br><span class="line"></span><br><span class="line">    # ä½¿ç”¨ asyncio.as_completed æ¥é€ä¸ªå¤„ç†ä¸‹è½½ä»»åŠ¡ï¼Œå¹¶åŠ å…¥éšæœºå»¶æ—¶</span><br><span class="line">    success_count = 0</span><br><span class="line">    pbar = aio_tqdm(total=len(tasks), desc=f&quot;&#123;log_prefix&#125;ä¸‹è½½ &#x27;&#123;post_title[:20]&#125;â€¦&#x27;&quot;, unit=&quot;å¼ &quot;, leave=False)</span><br><span class="line">    for task in asyncio.as_completed(tasks):</span><br><span class="line">        result, _ = await task</span><br><span class="line">        if result:</span><br><span class="line">            success_count += 1</span><br><span class="line">        pbar.update(1)</span><br><span class="line">        # å…³é”®ä¼˜åŒ–ï¼šåœ¨æ¯æ¬¡ä¸‹è½½åéƒ½åŠ å…¥ä¸€ä¸ªéšæœºçš„çŸ­æš‚å»¶æ—¶</span><br><span class="line">        await asyncio.sleep(random.uniform(0.5, 1.5))</span><br><span class="line">    pbar.close()</span><br><span class="line">    </span><br><span class="line">    failed_count = len(tasks) - success_count</span><br><span class="line"></span><br><span class="line">    if failed_count == 0:</span><br><span class="line">        logger.info(&quot;%sæˆåŠŸä¸º &#x27;%s&#x27; ä¸‹è½½ %d å¼ æ–°å›¾ç‰‡ã€‚&quot;, log_prefix, post_title, success_count)</span><br><span class="line">    else:</span><br><span class="line">        logger.error(&quot;%s&#x27;%s&#x27; ä¸‹è½½å®Œæˆï¼Œ%d å¼ æˆåŠŸ, %d å¼ å¤±è´¥ã€‚è¯¦æƒ…è¯·æŸ¥çœ‹é”™è¯¯æ—¥å¿—æ–‡ä»¶ã€‚&quot;, log_prefix, post_title, success_count, failed_count)</span><br><span class="line">        </span><br><span class="line">    # å°†æ ‡é¢˜æ·»åŠ åˆ°æ•°æ®åº“</span><br><span class="line">    await db.add_entry(post_title, feed_title)</span><br><span class="line">    return 1, success_count</span><br><span class="line"></span><br><span class="line">async def process_feed(session, db, feed_info):</span><br><span class="line">    &quot;&quot;&quot;</span><br><span class="line">    å¤„ç†å•ä¸ª RSS è®¢é˜…æºã€‚</span><br><span class="line">    ä¼˜å…ˆå°è¯•æ­£å¸¸è§£æï¼Œå¦‚æœå› å†…å®¹éXMLè€Œå¤±è´¥ï¼Œåˆ™è‡ªåŠ¨ä½¿ç”¨æµè§ˆå™¨User-Agenté‡è¯•ã€‚</span><br><span class="line">    &quot;&quot;&quot;</span><br><span class="line">    feed_title, feed_url = feed_info</span><br><span class="line">    log_prefix = f&quot;[&#123;feed_title&#125;] &quot;</span><br><span class="line">    logger.info(&quot;%så¼€å§‹å¤„ç†...&quot;, log_prefix)</span><br><span class="line"></span><br><span class="line">    try:</span><br><span class="line">        # --- æ­¥éª¤ 1: é¦–æ¬¡å°è¯•ï¼Œä¸å¸¦ä»»ä½•ä¼ªè£… ---</span><br><span class="line">        feed_data = await asyncio.to_thread(feedparser.parse, feed_url)</span><br><span class="line"></span><br><span class="line">        # --- æ­¥éª¤ 2: æ£€æŸ¥é¦–æ¬¡å°è¯•æ˜¯å¦å› â€œåçˆ¬è™«â€å¤±è´¥ ---</span><br><span class="line">        if feed_data.bozo and isinstance(feed_data.bozo_exception, feedparser.NonXMLContentType):</span><br><span class="line">            logger.warning(&quot;%sé¦–æ¬¡å°è¯•å¤±è´¥ï¼ŒæœåŠ¡å™¨è¿”å›äº†HTMLé¡µé¢ã€‚æ­£åœ¨åˆ‡æ¢ä¼ªè£…æ¨¡å¼é‡è¯•...&quot;, log_prefix)</span><br><span class="line">            </span><br><span class="line">            # --- æ­¥éª¤ 3: åˆ‡æ¢ä¸ºä¼ªè£…æ¨¡å¼è¿›è¡Œé‡è¯• ---</span><br><span class="line">            agent = CONFIG.get(&#x27;request_headers&#x27;, &#123;&#125;).get(&#x27;User-Agent&#x27;, &#x27;Mozilla/5.0&#x27;)</span><br><span class="line">            feed_data = await asyncio.to_thread(feedparser.parse, feed_url, agent=agent)</span><br><span class="line"></span><br><span class="line">        # --- æ­¥éª¤ 4: æ£€æŸ¥æœ€ç»ˆç»“æœ ---</span><br><span class="line">        if feed_data.bozo:</span><br><span class="line">            logger.warning(&quot;%sè®¢é˜…æºå¯èƒ½æ ¼å¼é”™è¯¯æˆ–æ— æ³•è®¿é—®: %s. é”™è¯¯: %s&quot;, log_prefix, feed_url, feed_data.bozo_exception)</span><br><span class="line">        </span><br><span class="line">        # åç»­é€»è¾‘ä¿æŒä¸å˜</span><br><span class="line">        entry_tasks = [process_entry(session, db, entry, feed_title) for entry in feed_data.entries]</span><br><span class="line">        results = await asyncio.gather(*entry_tasks)</span><br><span class="line">        </span><br><span class="line">        total_new_entries = sum(r[0] for r in results)</span><br><span class="line">        total_new_images = sum(r[1] for r in results)</span><br><span class="line"></span><br><span class="line">        logger.info(&quot;%så¤„ç†å®Œæ¯•ã€‚å‘ç° %d ç¯‡æ–°æ–‡ç« ï¼Œä¸‹è½½äº† %d å¼ æ–°å›¾ç‰‡ã€‚&quot;, log_prefix, total_new_entries, total_new_images)</span><br><span class="line">        return total_new_entries, total_new_images</span><br><span class="line">        </span><br><span class="line">    except Exception as e:</span><br><span class="line">        logger.error(&quot;%så¤„ç†æ—¶å‘ç”Ÿæ„å¤–é”™è¯¯: %s&quot;, log_prefix, e, exc_info=True)</span><br><span class="line">        return 0, 0</span><br><span class="line"></span><br><span class="line">async def main():</span><br><span class="line">    &quot;&quot;&quot;å¼‚æ­¥ä¸»å‡½æ•°ï¼Œè¿è¡Œä¸‹è½½å™¨ã€‚&quot;&quot;&quot;</span><br><span class="line">    load_config()</span><br><span class="line"></span><br><span class="line">    os.makedirs(CONFIG[&#x27;base_folder&#x27;], exist_ok=True)</span><br><span class="line">    db_path = os.path.join(CONFIG[&#x27;base_folder&#x27;], CONFIG[&#x27;db_file&#x27;])</span><br><span class="line">    db = DatabaseManager(db_path)</span><br><span class="line">    await db.connect()</span><br><span class="line"></span><br><span class="line">    try:</span><br><span class="line">        # å¦‚æœé…ç½®äº†cookieæ–‡ä»¶åˆ™åŠ è½½ï¼Œå¦åˆ™å¿½ç•¥</span><br><span class="line">        cookie_file = CONFIG.get(&#x27;cookie_file&#x27;)</span><br><span class="line">        if cookie_file and not os.path.exists(cookie_file):</span><br><span class="line">            logger.warning(f&quot;é…ç½®äº†cookieæ–‡ä»¶ &#x27;&#123;cookie_file&#125;&#x27; ä½†æ–‡ä»¶ä¸å­˜åœ¨ï¼Œå°†ä¸åŠ è½½Cookieã€‚&quot;)</span><br><span class="line">            cookie_jar = aiohttp.CookieJar()</span><br><span class="line">        else:</span><br><span class="line">            cookie_jar = NetscapeCookieJar(cookie_file)</span><br><span class="line"></span><br><span class="line">        connector = aiohttp.TCPConnector(limit_per_host=CONFIG.get(&#x27;max_concurrent_downloads&#x27;, 8))</span><br><span class="line">        </span><br><span class="line">        async with aiohttp.ClientSession(connector=connector, cookie_jar=cookie_jar) as session:</span><br><span class="line">            with open(CONFIG[&#x27;opml_file&#x27;], &#x27;r&#x27;, encoding=&#x27;utf-8&#x27;) as f:</span><br><span class="line">                opml_data = f.read()</span><br><span class="line">            </span><br><span class="line">            opml_soup = BeautifulSoup(opml_data, &#x27;xml&#x27;)</span><br><span class="line">            all_feeds = [</span><br><span class="line">                (outline.get(&#x27;text&#x27;, &#x27;æœªå‘½åæº&#x27;), outline.get(&#x27;xmlUrl&#x27;))</span><br><span class="line">                for outline in opml_soup.find_all(&#x27;outline&#x27;) if outline.get(&#x27;xmlUrl&#x27;)</span><br><span class="line">            ]</span><br><span class="line">            feeds_to_process = [f for f in all_feeds if f[0] not in CONFIG.get(&#x27;skip_feeds&#x27;, [])]</span><br><span class="line">            logger.info(&quot;åœ¨ %s ä¸­å‘ç° %d ä¸ªè®¢é˜…æºã€‚å°†å¤„ç† %d ä¸ªã€‚&quot;, CONFIG[&#x27;opml_file&#x27;], len(all_feeds), len(feeds_to_process))</span><br><span class="line"></span><br><span class="line">            stats = &#123;&#x27;new_entries&#x27;: 0, &#x27;new_images&#x27;: 0&#125;</span><br><span class="line">            </span><br><span class="line">            semaphore = asyncio.Semaphore(CONFIG.get(&#x27;max_concurrent_feeds&#x27;, 4))</span><br><span class="line">            </span><br><span class="line">            async def run_with_semaphore(feed_info):</span><br><span class="line">                async with semaphore:</span><br><span class="line">                    return await process_feed(session, db, feed_info)</span><br><span class="line"></span><br><span class="line">            feed_tasks = [run_with_semaphore(feed) for feed in feeds_to_process]</span><br><span class="line">            </span><br><span class="line">            for future in aio_tqdm.as_completed(feed_tasks, total=len(feed_tasks), desc=&quot;å¤„ç†è®¢é˜…æº&quot;, unit=&quot;ä¸ª&quot;):</span><br><span class="line">                new_entries, new_images = await future</span><br><span class="line">                stats[&#x27;new_entries&#x27;] += new_entries</span><br><span class="line">                stats[&#x27;new_images&#x27;] += new_images</span><br><span class="line"></span><br><span class="line">            logger.info(&quot;=&quot; * 60)</span><br><span class="line">            logger.info(&quot;æ‰€æœ‰è®¢é˜…æºå¤„ç†å®Œæ¯•ã€‚&quot;)</span><br><span class="line">            logger.info(&quot;æ€»è®¡å¤„ç†æ–°æ–‡ç« : %d ç¯‡&quot;, stats[&#x27;new_entries&#x27;])</span><br><span class="line">            logger.info(&quot;æ€»è®¡ä¸‹è½½æ–°å›¾ç‰‡: %d å¼ &quot;, stats[&#x27;new_images&#x27;])</span><br><span class="line">            logger.info(&quot;æ•°æ®åº“ä½äº: %s&quot;, os.path.abspath(db_path))</span><br><span class="line">            logger.info(&quot;=&quot; * 60)</span><br><span class="line"></span><br><span class="line">    except FileNotFoundError as e:</span><br><span class="line">        logger.error(&quot;æœªæ‰¾åˆ°å…³é”®æ–‡ä»¶: %s&quot;, e)</span><br><span class="line">    except Exception as e:</span><br><span class="line">        logger.critical(&quot;ä¸»ç¨‹åºå‘ç”Ÿä¸¥é‡é”™è¯¯: %s&quot;, e, exc_info=True)</span><br><span class="line">    finally:</span><br><span class="line">        await db.close()</span><br><span class="line"></span><br><span class="line">if __name__ == &quot;__main__&quot;:</span><br><span class="line">    parser = argparse.ArgumentParser(</span><br><span class="line">        description=&#x27;å¼‚æ­¥ RSS å›¾ç‰‡ä¸‹è½½å™¨ (æœ€ç»ˆä¼˜åŒ–ç‰ˆ - æ¨¡æ‹Ÿäººç±»è¡Œä¸º)&#x27;,</span><br><span class="line">        formatter_class=argparse.RawTextHelpFormatter</span><br><span class="line">    )</span><br><span class="line">    parser.add_argument(&#x27;--daemon&#x27;, action=&#x27;store_true&#x27;, help=&#x27;ä»¥å®ˆæŠ¤è¿›ç¨‹æ¨¡å¼è¿è¡Œï¼ŒæŒ‰å›ºå®šé—´éš”é‡å¤æ‰§è¡Œã€‚&#x27;)</span><br><span class="line">    parser.add_argument(</span><br><span class="line">        &#x27;--interval&#x27;, </span><br><span class="line">        type=int, </span><br><span class="line">        default=7200, </span><br><span class="line">        help=&#x27;å®ˆæŠ¤è¿›ç¨‹æ¨¡å¼ä¸‹çš„æ£€æŸ¥é—´éš”ï¼ˆç§’ï¼‰ã€‚\né»˜è®¤å€¼: 7200 (2å°æ—¶)ã€‚&#x27;</span><br><span class="line">    )</span><br><span class="line">    </span><br><span class="line">    args = parser.parse_args()</span><br><span class="line"></span><br><span class="line">    if not args.daemon:</span><br><span class="line">        try:</span><br><span class="line">            asyncio.run(main())</span><br><span class="line">        except KeyboardInterrupt:</span><br><span class="line">            logger.info(&quot;ç”¨æˆ·ä¸­æ–­äº†ç¨‹åºã€‚æ­£åœ¨å…³é—­...&quot;)</span><br><span class="line">    else:</span><br><span class="line">        logger.info(f&quot;å®ˆæŠ¤è¿›ç¨‹æ¨¡å¼å·²å¯åŠ¨ï¼Œè¿è¡Œé—´éš”ä¸º &#123;args.interval&#125; ç§’ (&#123;args.interval / 3600:.1f&#125; å°æ—¶)ã€‚&quot;)</span><br><span class="line">        while True:</span><br><span class="line">            start_time = time.time()</span><br><span class="line">            try:</span><br><span class="line">                logger.info(&quot;å¼€å§‹æ–°ä¸€è½®çš„æ£€æŸ¥ä¸ä¸‹è½½...&quot;)</span><br><span class="line">                asyncio.run(main())</span><br><span class="line">            except KeyboardInterrupt:</span><br><span class="line">                logger.info(&quot;å®ˆæŠ¤è¿›ç¨‹è¢«ç”¨æˆ·ä¸­æ–­ã€‚æ­£åœ¨é€€å‡º...&quot;)</span><br><span class="line">                break</span><br><span class="line">            except Exception as e:</span><br><span class="line">                logger.critical(f&quot;å®ˆæŠ¤è¿›ç¨‹åœ¨æ‰§è¡Œä»»åŠ¡æ—¶å‘ç”Ÿä¸¥é‡é”™è¯¯: &#123;e&#125;&quot;, exc_info=True)</span><br><span class="line">            </span><br><span class="line">            end_time = time.time()</span><br><span class="line">            elapsed = end_time - start_time</span><br><span class="line">            sleep_time = max(60, args.interval - elapsed)</span><br><span class="line">            </span><br><span class="line">            next_run_time_str = time.strftime(&#x27;%Y-%m-%d %H:%M:%S&#x27;, time.localtime(time.time() + sleep_time))</span><br><span class="line">            logger.info(f&quot;æœ¬è½®ä»»åŠ¡æ‰§è¡Œå®Œæ¯•ï¼Œè€—æ—¶ &#123;elapsed:.1f&#125; ç§’ã€‚å°†åœ¨ &#123;sleep_time:.1f&#125; ç§’åå¼€å§‹ä¸‹ä¸€è½®ï¼ˆé¢„è®¡æ—¶é—´: &#123;next_run_time_str&#125;ï¼‰ã€‚&quot;)</span><br><span class="line">            time.sleep(sleep_time)</span><br></pre></td></tr></table></figure>

<h2 id="âš™ï¸-é…ç½®æ–‡ä»¶"><a href="#âš™ï¸-é…ç½®æ–‡ä»¶" class="headerlink" title="âš™ï¸ é…ç½®æ–‡ä»¶"></a>âš™ï¸ é…ç½®æ–‡ä»¶</h2><p><code>config.yaml</code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"># ==============================================================================</span><br><span class="line"># é€šç”¨è®¾ç½®</span><br><span class="line"># ==============================================================================</span><br><span class="line"># æ‰€æœ‰ä¸‹è½½å†…å®¹çš„æ ¹ç›®å½•</span><br><span class="line">base_folder: &quot;photos&quot;</span><br><span class="line"># æ•°æ®åº“æ–‡ä»¶å (å°†åœ¨æ ¹ç›®å½•å†…åˆ›å»º)</span><br><span class="line">db_file: &quot;history.db&quot;</span><br><span class="line"># åŒ…å« RSS è®¢é˜…æºçš„ OPML æ–‡ä»¶</span><br><span class="line">opml_file: &quot;feeds.opml&quot;</span><br><span class="line"># ç”¨äºå­˜å‚¨é”™è¯¯å’Œå¤±è´¥è®°å½•çš„æ—¥å¿—æ–‡ä»¶</span><br><span class="line">error_log_file: &quot;downloader_errors.log&quot;</span><br><span class="line"># éœ€è¦è·³è¿‡å¤„ç†çš„è®¢é˜…æºæ ‡é¢˜åˆ—è¡¨</span><br><span class="line">skip_feeds:</span><br><span class="line">  - &quot;ç¤ºä¾‹ï¼šéœ€è¦è·³è¿‡çš„è®¢é˜…æº&quot;</span><br><span class="line"></span><br><span class="line"># æ˜¯å¦å…è®¸åœ¨RSSå†…å®¹ä¸ºç©ºæ—¶ï¼Œå›é€€åˆ°è®¿é—®åŸå§‹ç½‘ç«™é“¾æ¥ã€‚</span><br><span class="line"># å¯¹äºå†…å®¹å®Œæ•´çš„RSSæºï¼Œå¼ºçƒˆå»ºè®®è®¾ä¸º falseï¼Œå¯ä»¥æ ¹é™¤æŠ“å–åˆ°ç½‘ç«™æ¨èå›¾çš„é—®é¢˜ã€‚</span><br><span class="line"># å¦‚æœæœ‰ä¸€äº›åªæä¾›æ‘˜è¦çš„RSSæºï¼Œåˆ™éœ€è¦è®¾ä¸º trueã€‚</span><br><span class="line">allow_fallback_to_source_site: false</span><br><span class="line"></span><br><span class="line"># ==============================================================================</span><br><span class="line"># å¹¶å‘ä¸å»¶è¿Ÿè®¾ç½®</span><br><span class="line"># ==============================================================================</span><br><span class="line"># åŒæ—¶å¤„ç†çš„è®¢é˜…æºæœ€å¤§æ•°é‡</span><br><span class="line">max_concurrent_feeds: 1</span><br><span class="line"># æ¯ä¸ªæ¡ç›®åŒæ—¶ä¸‹è½½å›¾ç‰‡çš„æœ€å¤§æ•°é‡</span><br><span class="line">max_concurrent_downloads: 8</span><br><span class="line"># é€šç”¨ç½‘ç»œè¯·æ±‚è¶…æ—¶æ—¶é—´ (ç§’)</span><br><span class="line">request_timeout: 45</span><br><span class="line"># å¤±è´¥åé‡è¯•çš„åŸºç¡€å»¶è¿Ÿæ—¶é—´ (ç§’)</span><br><span class="line">retry_delay: 10</span><br><span class="line"># å•ä¸ªè¯·æ±‚å¤±è´¥åçš„æœ€å¤§é‡è¯•æ¬¡æ•°</span><br><span class="line">max_retries: 10</span><br><span class="line"></span><br><span class="line"># ==============================================================================</span><br><span class="line"># ç½‘ç»œè¯·æ±‚å¤´</span><br><span class="line"># ==============================================================================</span><br><span class="line"># ç”¨äºæŠ“å– RSS å’Œ HTML é¡µé¢çš„è¯·æ±‚å¤´</span><br><span class="line">request_headers:</span><br><span class="line">  User-Agent: &quot;Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/125.0.0.0 Safari/537.36&quot;</span><br><span class="line">  Accept: &quot;text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8&quot;</span><br><span class="line">  Accept-Language: &quot;en-US,en;q=0.9,zh-CN;q=0.8&quot;</span><br><span class="line"></span><br><span class="line"># ç”¨äºä¸‹è½½å›¾ç‰‡çš„è¯·æ±‚å¤´</span><br><span class="line">image_headers:</span><br><span class="line">  User-Agent: &quot;Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/125.0.0.0 Safari/537.36&quot;</span><br><span class="line">  Accept: &quot;image/webp,image/apng,image/*,*/*;q=0.8&quot;</span><br><span class="line"></span><br><span class="line"># ==============================================================================</span><br><span class="line"># æ–‡ä»¶å¤¹ä¸æ–‡ä»¶åè§„åˆ™</span><br><span class="line"># ==============================================================================</span><br><span class="line">folder_name_rules:</span><br><span class="line">  max_length: 150</span><br><span class="line">  # éœ€è¦è¢«æ›¿æ¢çš„ç‰¹æ®Šå­—ç¬¦</span><br><span class="line">  replace_chars:</span><br><span class="line">    &#x27;[&#x27;: &#x27;ã€&#x27;</span><br><span class="line">    &#x27;]&#x27;: &#x27;ã€‘&#x27;</span><br><span class="line">    &#x27;:&#x27;: &#x27;ï¼š&#x27;</span><br><span class="line">    &#x27;*&#x27;: &#x27;ï¼Š&#x27;</span><br><span class="line">    &#x27;?&#x27;: &#x27;ï¼Ÿ&#x27;</span><br><span class="line">    &#x27;&quot;&#x27;: &#x27;â€œ&#x27;</span><br><span class="line">    &#x27;&lt;&#x27;: &#x27;ï¼œ&#x27;</span><br><span class="line">    &#x27;&gt;&#x27;: &#x27;ï¼&#x27;</span><br><span class="line">    &#x27;|&#x27;: &#x27;ï½œ&#x27;</span><br></pre></td></tr></table></figure>

<h2 id="ğŸ“¡-æ¼”ç¤ºRSSæº"><a href="#ğŸ“¡-æ¼”ç¤ºRSSæº" class="headerlink" title="ğŸ“¡ æ¼”ç¤ºRSSæº"></a>ğŸ“¡ æ¼”ç¤ºRSSæº</h2><p><code>feeds.opml</code> </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span><br><span class="line">&lt;opml version=&quot;2.0&quot;&gt;</span><br><span class="line">  &lt;head&gt;</span><br><span class="line">    &lt;title&gt;My RSS Feeds&lt;/title&gt;</span><br><span class="line">  &lt;/head&gt;</span><br><span class="line">  &lt;body&gt;</span><br><span class="line">    &lt;outline text=&quot;ğŸ–¼ï¸å›¾ç‰‡ç”»å»Š&quot;&gt;</span><br><span class="line">      &lt;outline text=&quot;80K - å†™çœŸç½‘&quot; type=&quot;rss&quot; xmlUrl=&quot;https://127.0.0.1&quot; htmlUrl=&quot;https://127.0.0.1&quot;/&gt;</span><br><span class="line">    &lt;/outline&gt;</span><br><span class="line">  &lt;/body&gt;</span><br><span class="line">&lt;/opml&gt;</span><br></pre></td></tr></table></figure>
<h2 id="ğŸ”—-è„šæœ¬ä¾èµ–"><a href="#ğŸ”—-è„šæœ¬ä¾èµ–" class="headerlink" title="ğŸ”— è„šæœ¬ä¾èµ–"></a>ğŸ”— è„šæœ¬ä¾èµ–</h2><p><code>requirements.txt</code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">aiohttp[cchardet,aiodns]</span><br><span class="line">aiosqlite</span><br><span class="line">beautifulsoup4</span><br><span class="line">feedparser</span><br><span class="line">PyYAML</span><br><span class="line">tqdm</span><br><span class="line">lxm</span><br></pre></td></tr></table></figure>

<h2 id="ğŸš€-å®‰è£…ä¸è®¾ç½®"><a href="#ğŸš€-å®‰è£…ä¸è®¾ç½®" class="headerlink" title="ğŸš€ å®‰è£…ä¸è®¾ç½®"></a>ğŸš€ å®‰è£…ä¸è®¾ç½®</h2><h4 id="1-ç¯å¢ƒå‡†å¤‡"><a href="#1-ç¯å¢ƒå‡†å¤‡" class="headerlink" title="1. ç¯å¢ƒå‡†å¤‡"></a>1. ç¯å¢ƒå‡†å¤‡</h4><p>å®‰è£… <strong>Python</strong> </p>
<h4 id="2-è·å–æ–‡ä»¶"><a href="#2-è·å–æ–‡ä»¶" class="headerlink" title="2. è·å–æ–‡ä»¶"></a>2. è·å–æ–‡ä»¶</h4><p>æŠŠåˆ›å»ºçš„æ‰€æœ‰æ–‡ä»¶ (<code>.py</code>, <code>.yaml</code>, <code>feeds.opml</code>,<code>.txt</code>) å¹¶å°†å®ƒä»¬æ”¾åœ¨åŒä¸€ä¸ªæ–‡ä»¶å¤¹ä¸­ã€‚</p>
<h4 id="3-å®‰è£…ä¾èµ–"><a href="#3-å®‰è£…ä¾èµ–" class="headerlink" title="3. å®‰è£…ä¾èµ–"></a>3. å®‰è£…ä¾èµ–</h4><p>è¿›å…¥é¡¹ç›®æ‰€åœ¨çš„æ–‡ä»¶å¤¹ï¼Œæ‰“å¼€ç»ˆç«¯ ï¼Œç„¶åè¿è¡Œä»¥ä¸‹å‘½ä»¤æ¥å®‰è£…æ‰€æœ‰å¿…éœ€çš„ Python åº“ï¼š</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pip install -r requirements.txt</span><br></pre></td></tr></table></figure>

<p><strong>ä¸»è¦ä¾èµ–åº“åŒ…æ‹¬</strong>: <code>aiohttp</code>, <code>aiosqlite</code>, <code>beautifulsoup4</code>, <code>feedparser</code>, <code>pyyaml</code>, <code>tqdm</code>, <code>lxm</code>ã€‚</p>
<h2 id="âš™ï¸-é…ç½®è¯´æ˜"><a href="#âš™ï¸-é…ç½®è¯´æ˜" class="headerlink" title="âš™ï¸ é…ç½®è¯´æ˜"></a>âš™ï¸ é…ç½®è¯´æ˜</h2><h4 id="1-é…ç½®è®¢é˜…æº-feeds-opml"><a href="#1-é…ç½®è®¢é˜…æº-feeds-opml" class="headerlink" title="1. é…ç½®è®¢é˜…æº (feeds.opml)"></a>1. é…ç½®è®¢é˜…æº (<code>feeds.opml</code>)</h4><p>æœ€å…³é”®çš„ä¸€æ­¥ã€‚ä»RSS é˜…è¯»å™¨ï¼ˆå¦‚ Feedly, Inoreader, Freshrss ç­‰ï¼‰ä¸­ï¼Œå°†æ‚¨çš„è®¢é˜…æºå¯¼å‡ºä¸º OPML æ–‡ä»¶æ ¼å¼ã€‚å°†å¯¼å‡ºçš„æ–‡ä»¶å‘½åä¸º <code>feeds.opml</code> å¹¶æ”¾å…¥é¡¹ç›®æ–‡ä»¶å¤¹ã€‚</p>
<blockquote>
<p><strong>æç¤º</strong>: è¯·ç¡®ä¿å¯¼å‡ºçš„ OPML æ–‡ä»¶æ˜¯ UTF-8 ç¼–ç ï¼Œä»¥é¿å…è§£æé”™è¯¯ã€‚</p>
</blockquote>
<h4 id="2-è°ƒæ•´ä¸»é…ç½®-config-yaml"><a href="#2-è°ƒæ•´ä¸»é…ç½®-config-yaml" class="headerlink" title="2. è°ƒæ•´ä¸»é…ç½® (config.yaml)"></a>2. è°ƒæ•´ä¸»é…ç½® (<code>config.yaml</code>)</h4><p>æ‰“å¼€ <code>config.yaml</code> æ–‡ä»¶ï¼Œæ ¹æ®é‡Œé¢çš„ä¸­æ–‡æ³¨é‡Šä¿®æ”¹é…ç½®é¡¹ã€‚æœ€é‡è¦çš„å‡ é¡¹æ˜¯ï¼š</p>
<ul>
<li><code>base_folder</code>: å›¾ç‰‡ä¿å­˜çš„ç›®å½•ã€‚</li>
<li><strong>åçˆ¬è™«ç­–ç•¥ç›¸å…³</strong>:<ul>
<li><code>max_concurrent_feeds</code>: åŒæ—¶å¤„ç†çš„ç½‘ç«™ï¼ˆè®¢é˜…æºï¼‰æ•°é‡ã€‚<strong>å»ºè®®é¦–æ¬¡è¿è¡Œæˆ–é‡åˆ°é¢‘ç¹å¤±è´¥æ—¶è®¾ä¸º <code>1</code></strong>ã€‚</li>
<li><code>max_concurrent_downloads</code>: åŒæ—¶ä¸‹è½½çš„å›¾ç‰‡æ•°é‡ã€‚<strong>å»ºè®®è®¾ä¸º <code>1</code> åˆ° <code>8</code> ä¹‹é—´ï¼Œæ•°å€¼è¶Šå°è¶Šä¸å®¹æ˜“è¢«å°é”</strong>ã€‚</li>
<li><code>retry_delay</code>: æ¯æ¬¡é‡è¯•çš„åŸºç¡€ç­‰å¾…æ—¶é—´ï¼ˆç§’ï¼‰ã€‚<strong>å¦‚æœé¢‘ç¹å¤±è´¥ï¼Œå¯ä»¥é€‚å½“å¢åŠ æ­¤å€¼ï¼Œä¾‹å¦‚ <code>10</code></strong>ã€‚</li>
</ul>
</li>
<li><code>(å¯é€‰) Cookie é…ç½®</code>:<ul>
<li><code>cookie_file</code>: å¦‚æœè¦ä¸‹è½½ç™»å½•åæ‰èƒ½è®¿é—®çš„å†…å®¹ï¼Œå¯ä»¥åœ¨æ­¤æŒ‡å®š <code>cookies.txt</code> æ–‡ä»¶çš„è·¯å¾„ã€‚</li>
</ul>
</li>
</ul>
<h2 id="â–¶ï¸-å¦‚ä½•ä½¿ç”¨"><a href="#â–¶ï¸-å¦‚ä½•ä½¿ç”¨" class="headerlink" title="â–¶ï¸ å¦‚ä½•ä½¿ç”¨"></a>â–¶ï¸ å¦‚ä½•ä½¿ç”¨</h2><h4 id="é¦–æ¬¡è¿è¡Œå»ºè®®"><a href="#é¦–æ¬¡è¿è¡Œå»ºè®®" class="headerlink" title="é¦–æ¬¡è¿è¡Œå»ºè®®"></a>é¦–æ¬¡è¿è¡Œå»ºè®®</h4><ol>
<li>å°† <code>config.yaml</code> ä¸­çš„ <code>max_concurrent_feeds</code> å’Œ <code>max_concurrent_downloads</code> éƒ½è®¾ç½®ä¸º <code>1</code>ã€‚</li>
<li>è¿è¡Œè„šæœ¬è¿›è¡Œæµ‹è¯•ã€‚</li>
<li>å¦‚æœä¸‹è½½ç¨³å®šï¼Œå†é€æ­¥è°ƒé«˜å¹¶å‘æ•°ï¼Œæ‰¾åˆ°é€Ÿåº¦å’Œç¨³å®šæ€§çš„å¹³è¡¡ç‚¹ã€‚</li>
</ol>
<h4 id="å¯åŠ¨å‘½ä»¤"><a href="#å¯åŠ¨å‘½ä»¤" class="headerlink" title="å¯åŠ¨å‘½ä»¤"></a>å¯åŠ¨å‘½ä»¤</h4><p>å®Œæˆæ‰€æœ‰é…ç½®åï¼Œåœ¨ç»ˆç«¯ä¸­è¿›å…¥é¡¹ç›®æ–‡ä»¶å¤¹ï¼Œè¿è¡Œä»¥ä¸‹å‘½ä»¤å³å¯å¯åŠ¨è„šæœ¬ï¼š</p>
<p><strong>1. æ ‡å‡†æ¨¡å¼ï¼š</strong> (è¿è¡Œä¸€æ¬¡åè‡ªåŠ¨é€€å‡º)</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python downloader.py</span><br></pre></td></tr></table></figure>

<p><strong>2. å®ˆæŠ¤è¿›ç¨‹æ¨¡å¼ï¼š</strong> (ä½¿ç”¨é»˜è®¤çš„2å°æ—¶é—´éš”ï¼Œåœ¨åå°æŒç»­è¿è¡Œ)</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python downloader.py --daemon</span><br></pre></td></tr></table></figure>

<p><strong>3. å®ˆæŠ¤è¿›ç¨‹æ¨¡å¼ + è‡ªå®šä¹‰é—´éš”ï¼š</strong> (æ¯30åˆ†é’Ÿæ£€æŸ¥ä¸€æ¬¡)</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python downloader.py --daemon --interval 1800</span><br></pre></td></tr></table></figure>

<p>è„šæœ¬å°†å¼€å§‹è¯»å– <code>feeds.opml</code>ï¼Œæ£€æŸ¥æ•°æ®åº“å†å²è®°å½•ï¼Œå¹¶ä¸‹è½½æ‰€æœ‰æ–°çš„å›¾é›†ã€‚æ‚¨å¯ä»¥åœ¨æ§åˆ¶å°çœ‹åˆ°è¯¦ç»†çš„è¿›åº¦å’Œæ—¥å¿—ã€‚</p>

      </div>
      
        <div class="prev-or-next">
          <div class="post-foot-next">
            
              <a href="/posts/e50f2787/" target="_self">
                <i class="iconfont icon-chevronleft"></i>
                <span>ä¸Šä¸€é¡µ</span>
              </a>
            
          </div>
          <div class="post-attach">
            <span class="post-pubtime">
              <i class="iconfont icon-updatetime mr-10" title="æ›´æ–°æ—¶é—´"></i>
              2025-06-28 04:23:53
            </span>
            
                  <span class="post-tags">
                    <i class="iconfont icon-tags mr-10" title="æ ‡ç­¾"></i>
                    
                    <span class="span--tag mr-8">
                      <a href="/tags/Python/" title="Python">
                        #Python
                      </a>
                    </span>
                    
                  </span>
              
          </div>
          <div class="post-foot-prev">
            
          </div>
        </div>
      
    </div>
    
  <div id="btn-catalog" class="btn-catalog">
    <i class="iconfont icon-catalog"></i>
  </div>
  <div class="post-catalog hidden" id="catalog">
    <div class="title">ç›®å½•</div>
    <div class="catalog-content">
      
        <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E2%9A%A0%EF%B8%8F-%E6%B3%A8%E6%84%8F%E4%BA%8B%E9%A1%B9"><span class="toc-text">âš ï¸ æ³¨æ„äº‹é¡¹</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%F0%9F%93%81-%E6%96%87%E4%BB%B6%E7%BB%93%E6%9E%84"><span class="toc-text">ğŸ“ æ–‡ä»¶ç»“æ„</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%F0%9F%90%8D-%E4%B8%BB%E7%A8%8B%E5%BA%8F"><span class="toc-text">ğŸ ä¸»ç¨‹åº</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E2%9A%99%EF%B8%8F-%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6"><span class="toc-text">âš™ï¸ é…ç½®æ–‡ä»¶</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%F0%9F%93%A1-%E6%BC%94%E7%A4%BARSS%E6%BA%90"><span class="toc-text">ğŸ“¡ æ¼”ç¤ºRSSæº</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%F0%9F%94%97-%E8%84%9A%E6%9C%AC%E4%BE%9D%E8%B5%96"><span class="toc-text">ğŸ”— è„šæœ¬ä¾èµ–</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%F0%9F%9A%80-%E5%AE%89%E8%A3%85%E4%B8%8E%E8%AE%BE%E7%BD%AE"><span class="toc-text">ğŸš€ å®‰è£…ä¸è®¾ç½®</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-%E7%8E%AF%E5%A2%83%E5%87%86%E5%A4%87"><span class="toc-text">1. ç¯å¢ƒå‡†å¤‡</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-%E8%8E%B7%E5%8F%96%E6%96%87%E4%BB%B6"><span class="toc-text">2. è·å–æ–‡ä»¶</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-%E5%AE%89%E8%A3%85%E4%BE%9D%E8%B5%96"><span class="toc-text">3. å®‰è£…ä¾èµ–</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E2%9A%99%EF%B8%8F-%E9%85%8D%E7%BD%AE%E8%AF%B4%E6%98%8E"><span class="toc-text">âš™ï¸ é…ç½®è¯´æ˜</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-%E9%85%8D%E7%BD%AE%E8%AE%A2%E9%98%85%E6%BA%90-feeds-opml"><span class="toc-text">1. é…ç½®è®¢é˜…æº (feeds.opml)</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-%E8%B0%83%E6%95%B4%E4%B8%BB%E9%85%8D%E7%BD%AE-config-yaml"><span class="toc-text">2. è°ƒæ•´ä¸»é…ç½® (config.yaml)</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E2%96%B6%EF%B8%8F-%E5%A6%82%E4%BD%95%E4%BD%BF%E7%94%A8"><span class="toc-text">â–¶ï¸ å¦‚ä½•ä½¿ç”¨</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%A6%96%E6%AC%A1%E8%BF%90%E8%A1%8C%E5%BB%BA%E8%AE%AE"><span class="toc-text">é¦–æ¬¡è¿è¡Œå»ºè®®</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%90%AF%E5%8A%A8%E5%91%BD%E4%BB%A4"><span class="toc-text">å¯åŠ¨å‘½ä»¤</span></a></li></ol></li></ol></li></ol>
      
    </div>
  </div>

  
<script src="/js/catalog.js"></script>




    
  </div>


        
  <div class="footer">
    <div class="social">
      <ul>
        
      </ul>
    </div>
    
      
        <div class="footer-more">
          
            <a href="/">Â© 2026 ï¼¸å°ç«™</a>
            
        </div>
        
          

  </div>

  
<script src="/js/bug.js"></script>

      </div>

      <div class="tools-bar">
        <div class="back-to-top tools-bar-item hidden">
  <a href="javascript: void(0)" rel="external nofollow noreferrer">
    <i class="iconfont icon-chevronup"></i>
  </a>
</div>


<script src="/js/backtotop.js"></script>



        
  <div class="search-icon tools-bar-item" id="search-icon">
    <a href="javascript: void(0)" rel="external nofollow noreferrer">
      <i class="iconfont icon-search"></i>
    </a>
  </div>

  <div class="search-overlay hidden">
    <div class="search-content" tabindex="0">
      <div class="search-title">
        <span class="search-icon-input">
          <a href="javascript: void(0)" rel="external nofollow noreferrer">
            <i class="iconfont icon-search"></i>
          </a>
        </span>
        
          <input type="text" class="search-input" id="search-input" placeholder="æœç´¢...">
          
              <span class="search-close-icon" id="search-close-icon">
                <a href="javascript: void(0)" rel="external nofollow noreferrer">
                  <i class="iconfont icon-close"></i>
                </a>
              </span>
      </div>
      <div class="search-result" id="search-result"></div>
    </div>
  </div>

  <script type="text/javascript">
    var inputArea = document.querySelector("#search-input")
    var searchOverlayArea = document.querySelector(".search-overlay")

    inputArea.onclick = function () {
      getSearchFile()
      this.onclick = null
    }

    inputArea.onkeydown = function () {
      if (event.keyCode == 13)
        return false
    }

    function openOrHideSearchContent() {
      let isHidden = searchOverlayArea.classList.contains('hidden')
      if (isHidden) {
        searchOverlayArea.classList.remove('hidden')
        document.body.classList.add('hidden')
        // inputArea.focus()
      } else {
        searchOverlayArea.classList.add('hidden')
        document.body.classList.remove('hidden')
      }
    }

    function blurSearchContent(e) {
      if (e.target === searchOverlayArea) {
        openOrHideSearchContent()
      }
    }

    document.querySelector("#search-icon").addEventListener("click", openOrHideSearchContent, false)
    document.querySelector("#search-close-icon").addEventListener("click", openOrHideSearchContent, false)
    searchOverlayArea.addEventListener("click", blurSearchContent, false)

    var searchFunc = function (path, search_id, content_id) {
      'use strict';
      var $input = document.getElementById(search_id);
      var $resultContent = document.getElementById(content_id);
      $resultContent.innerHTML = "<ul><span class='local-search-empty'>é¦–æ¬¡æœç´¢ï¼Œæ­£åœ¨è½½å…¥ç´¢å¼•æ–‡ä»¶ï¼Œè¯·ç¨åâ€¦â€¦<span></ul>";
      $.ajax({
        // 0x01. load xml file
        url: path,
        dataType: "xml",
        success: function (xmlResponse) {
          // 0x02. parse xml file
          var datas = $("entry", xmlResponse).map(function () {
            return {
              title: $("title", this).text(),
              content: $("content", this).text(),
              url: $("url", this).text()
            };
          }).get();
          $resultContent.innerHTML = "";

          // Debounce function
          var debounce = function (func, wait) {
            var timeout;
            return function () {
              var context = this;
              var args = arguments;
              var later = function () {
                timeout = null;
                func.apply(context, args);
              };
              clearTimeout(timeout);
              timeout = setTimeout(later, wait);
            };
          };

          $input.addEventListener('input', debounce(function () {
            // 0x03. parse query to keywords list
            var str = '<ul class=\"search-result-list\">';
            var keywords = this.value.trim().toLowerCase().split(/[\s\-]+/);
            $resultContent.innerHTML = "";
            if (this.value.trim().length <= 0) {
              return;
            }
            // 0x04. perform local searching
            datas.forEach(function (data) {
              var isMatch = true;
              var content_index = [];
              if (!data.title || data.title.trim() === '') {
                data.title = "Untitled";
              }
              var orig_data_title = data.title.trim();
              var data_title = orig_data_title.toLowerCase();
              var orig_data_content = data.content.trim().replace(/<[^>]+>/g, "");
              var data_content = orig_data_content.toLowerCase();
              var data_url = data.url;
              var index_title = -1;
              var index_content = -1;
              var first_occur = -1;
              // only match artiles with not empty contents
              if (data_content !== '') {
                keywords.forEach(function (keyword, i) {
                  index_title = data_title.indexOf(keyword);
                  index_content = data_content.indexOf(keyword);

                  if (index_title < 0 && index_content < 0) {
                    isMatch = false;
                  } else {
                    if (index_content < 0) {
                      index_content = 0;
                    }
                    if (i == 0) {
                      first_occur = index_content;
                    }
                    // content_index.push({index_content:index_content, keyword_len:keyword_len});
                  }
                });
              } else {
                isMatch = false;
              }
              // 0x05. show search results
              if (isMatch) {
                str += "<li><a href='" + data_url + "' class='search-result-title'>" + orig_data_title + "</a>";
                var content = orig_data_content;
                if (first_occur >= 0) {
                  // cut out 100 characters
                  var start = first_occur - 20;
                  var end = first_occur + 80;

                  if (start < 0) {
                    start = 0;
                  }

                  if (start == 0) {
                    end = 100;
                  }

                  if (end > content.length) {
                    end = content.length;
                  }

                  var match_content = content.substr(start, end);

                  // highlight all keywords
                  keywords.forEach(function (keyword) {
                    var regS = new RegExp(keyword, "gi");
                    match_content = match_content.replace(regS, "<span class=\"search-keyword\">" + keyword + "</span>");
                  });

                  str += "<p class=\"search-result-abstract\">" + match_content + "...</p>"
                }
                str += "</li>";
              }
            });
            str += "</ul>";
            if (str.indexOf('<li>') === -1) {
              return $resultContent.innerHTML = "<ul><span class='local-search-empty'>æ²¡æœ‰æ‰¾åˆ°å†…å®¹ï¼Œè¯·å°è¯•æ›´æ¢æ£€ç´¢è¯ã€‚<span></ul>";
            }
            $resultContent.innerHTML = str;
          }, 300));
        },
        error: function (xhr, status, error) {
          $resultContent.innerHTML = ""
          if (xhr.status === 404) {
            $resultContent.innerHTML = `<ul><span class="local-search-empty">æœªæ‰¾åˆ°search.xmlæ–‡ä»¶ï¼Œå…·ä½“è¯·å‚è€ƒï¼š<a href="https://github.com/zchengsite/hexo-theme-oranges#configuration" rel="external nofollow noreferrer" target="_black">configuration</a><span></ul>`;
          } else {
            $resultContent.innerHTML = "<ul><span class='local-search-empty'>è¯·æ±‚å¤±è´¥ï¼Œå°è¯•é‡æ–°åˆ·æ–°é¡µé¢æˆ–ç¨åé‡è¯•ã€‚<span></ul>";
          }
        }
      });
      $(document).on('click', '#search-close-icon', function () {
        $('#search-input').val('');
        $('#search-result').html('');
      });
    }

    var getSearchFile = function () {
      var path = "/search.xml";
      searchFunc(path, 'search-input', 'search-result');
    }
  </script>

  

        


        

      </div>
    </div>
  
        <style>
            [bg-lazy] {
                background-image: none !important;
                background-color: #eee !important;
            }
        </style>
        <script>
            window.imageLazyLoadSetting = {
                isSPA: false,
                preloadRatio: 1,
                processImages: null,
            };
        </script><script>window.addEventListener("load",function(){var t=/\.(gif|jpg|jpeg|tiff|png)$/i,r=/^data:image\/[a-z\d\-\.\+]+;base64,/;Array.prototype.slice.call(document.querySelectorAll("img[data-original]")).forEach(function(a){var e=a.parentNode;"A"===e.tagName&&(t.test(e.href)||r.test(e.href))&&(e.href=a.dataset.original)})});</script><script>(r=>{r.imageLazyLoadSetting.processImages=t;var a=r.imageLazyLoadSetting.isSPA,o=r.imageLazyLoadSetting.preloadRatio||1,d=i();function i(){var t=Array.prototype.slice.call(document.querySelectorAll("img[data-original]")),e=Array.prototype.slice.call(document.querySelectorAll("[bg-lazy]"));return t.concat(e)}function t(t){(a||t)&&(d=i());for(var e,n=0;n<d.length;n++)0<=(e=(e=d[n]).getBoundingClientRect()).bottom&&0<=e.left&&e.top<=(r.innerHeight*o||document.documentElement.clientHeight*o)&&(()=>{var t,e,a,o,i=d[n];e=function(){d=d.filter(function(t){return i!==t}),r.imageLazyLoadSetting.onImageLoaded&&r.imageLazyLoadSetting.onImageLoaded(i)},(t=i).dataset.loaded||(t.hasAttribute("bg-lazy")?(t.removeAttribute("bg-lazy"),e&&e()):(a=new Image,o=t.getAttribute("data-original"),a.onload=function(){t.src=o,t.removeAttribute("data-original"),t.setAttribute("data-loaded",!0),e&&e()},a.onerror=function(){t.removeAttribute("data-original"),t.setAttribute("data-loaded",!1),t.src=o},t.src!==o&&(a.src=o)))})()}function e(){clearTimeout(t.tId),t.tId=setTimeout(t,500)}t(),document.addEventListener("scroll",e),r.addEventListener("resize",e),r.addEventListener("orientationchange",e)})(this);</script></body>
</html>
